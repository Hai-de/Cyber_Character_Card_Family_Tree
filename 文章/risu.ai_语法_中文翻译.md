> 原文版本https://kwaroran.github.io/docs/syntax/cbs/

> 声明: 本文使用了Gemini2.5pro进行翻译

> 更新日期: 2025-08-05

# 花括号语法

花括号语法（如 {{user}}）用于在文本中插入特殊值。该语法几乎可以用于客户端中的任何文本字段，包括聊天消息、角色描述和知识库条目。

当消息发送或文本在客户端中显示时，这些语法会被替换为实际值。语法可以嵌套并与其他语法组合，例如 {{calc::{{getvar::a}}+{{getvar::b}}}}。

语法不区分大小写，因此 {{user}}、{{User}} 和 {{USER}} 都是相同的。某些语法需要参数，参数之间用 ::（两个冒号）分隔。

某些语法需要数组作为参数。使用 {{array::A::B::C...}} 语法来创建数组。某些语法是块语法（如 {{#if A}}），以 {{#NAME A}} 开始，以 {{/NAME}} 结束。块语法可以嵌套，并以 # 开头。它也可以用 {{/}} 而不是 {{/NAME}} 来关闭。块语法内容的缩进和空白将被修剪，除非像 {{#if-pure A}} 这样的某些语法会保留缩进和空白。

# 数据语法

## {{user}}

这将被替换为用户角色的名字。

## {{char}}

这将被替换为角色的名字。如果您在群聊中，如果发言者是用户，这将被替换为群聊名称。如果发言者是角色，这将被替换为发言者的名字。

## {{description}}

别名: {{char_desc}}

这将被替换为角色的描述。

## {{example_dialogue}}

别名: {{example_message}}

这将被替换为角色示例对话的数组。

## {{persona}}

别名: {{user_persona}}

这将被替换为用户角色的描述。

## {{lorebook}}

别名: {{world_info}}

这将被替换为知识库条目的数组。

## {{history}}

别名: {{messages}}

这将被替换为当前聊天中消息的数组。

## {{chat_index}}

这将被替换为消息在聊天中的索引。聊天索引从 0 开始，但第一条消息除外。第一条消息的索引为 -1。如果 {{chat_index}} 在非聊天上下文中使用，它将被替换为 -1。

## {{model}}

这将被替换为客户端的当前模型 ID。

## {{axmodel}}

这将被替换为客户端的当前辅助模型 ID。

## {{role}}

这将被替换为当前消息发送者的角色。如果 {{role}} 在非聊天上下文中使用，它将被替换为角色字符串。

## {{maxprompt}}

这将被替换为客户端的最大令牌设置。

## {{lastmessage}}

这将被替换为聊天记录中的最后一条消息。

## {{lastmessageid}}

别名: {{lastmessageindex}}

这将被替换为聊天记录中最后一条消息的索引。

## {{previous_char_chat}}

别名: {{lastcharmessage}}

这将被替换为当前角色在聊天记录中的最后一条消息。

## {{previous_user_chat}}

别名: {{lastusermessage}}

这将被替换为用户在聊天记录中的最后一条消息。

## {{previous_chat_log::A}}

这将被替换为聊天记录中索引为 A 的聊天消息。如果消息不存在，它将被替换为 Out of range。

## {{first_msg_index}}

这将被替换为聊天记录中第一条消息的索引。

## {{screen_width}}

这将被替换为屏幕的宽度（以像素为单位）。

## {{screen_height}}

这将被替换为屏幕的高度（以像素为单位）。

## {{user_history}}

这将被替换为聊天记录中用户消息的数组。

## {{char_history}}

这将被替换为聊天记录中角色消息的数组。

# 时间语法

## {{time}}

这将被替换为客户端时区的当前时间，格式为 HH:MM:SS。

## {{time::A}}

别名: {{datetimeformat:A}}, {{date::A}}

这将被替换为客户端时区的当前时间，格式为 A。

格式 A 可以包括以下内容：

YYYY 表示年份。

YY 表示两位数年份。

MM 表示月份。

DD 表示日期。

DDDD 表示一年中的第几天。

HH 表示小时（24 小时制）。

hh 表示小时（12 小时制）。

mm 表示分钟。

ss 表示秒。

A 表示 AM/PM 指示符。

X 表示 Unix 时间戳。

x 表示毫秒级的 Unix 时间戳。

例如，如果当前时间是 2024-12-31 23:59:59，{{time::YYYY-MM-DD HH:mm:ss}} 将被替换为 2024-12-31 23:59:59。

## {{time::A::B}}

别名: {{datetimeformat::A::B}}, {{date::A::B}}

与 {{time::A}} 相同，但时间将是 Unix 时间戳 B，而不是当前时间。

## {{date}}

这将被替换为客户端时区的当前日期，格式为 YYYY-MM-DD。

## {{isotime}}

这将被替换为 UTC 时区的当前时间，格式为 HH:MM:SS。

## {{isodate}}

这将被替换为 UTC 时区的当前日期，格式为 YYYY-MM-DD。

## {{message_time}}

这将被替换为消息发送的时间。返回的时间格式将由浏览器或操作系统设置决定。

如果 {{message_time}} 在非聊天上下文或第一条消息中使用，它将被替换为 [Cannot get time] 字符串。如果消息是在引入 {{message_time}} 语法之前发送的，它将被替换为 [Cannot get time, message was sent in older version] 字符串。

## {{message_date}}

这将被替换为消息发送的日期。返回的日期格式将由浏览器或操作系统设置决定。

如果 {{message_date}} 在非聊天上下文或第一条消息中使用，它将被替换为 [Cannot get time] 字符串。如果消息是在引入 {{message_date}} 语法之前发送的，它将被替换为 [Cannot get time, message was sent in older version] 字符串。

## {{message_idle_duration}}

这将被替换为用户上一条消息发送的时间减去用户上上条消息发送的时间。返回的时间格式为 HH:MM:SS。

如果 {{message_idle_duration}} 在非聊天上下文或第一条消息中使用，它将被替换为 [Cannot get time] 字符串。如果消息是在引入 {{message_idle_duration}} 语法之前发送的，它将被替换为 [Cannot get time, message was sent in older version] 字符串。如果没有先前的消息，它将被替换为 [No user message found] 字符串。

## {{idle_duration}}

这将被替换为当前时间减去用户上一条消息发送的时间。返回的时间格式为 HH:MM:SS。

## {{message_unixtime_array}}

这将被替换为聊天记录中 Unix 时间戳的数组。

# 情感/资源语法

## {{asset::A}}

这将被替换为具有当前角色名为 A 的附加资源路径数据的源的元素。元素的类型将由资源类型自动确定。

## {{emotion::A}}

这将被替换为具有当前角色名为 A 的情感图像路径数据的源的图像元素。

## {{audio::A}}

这将被替换为具有当前角色名为 A 的附加资源路径数据的源的音频元素。

{{bg::A}}

这将被替换为具有当前角色名为 A 的附加资源路径数据的源的背景图像元素。

## {{video::A}}

这将被替换为具有当前角色名为 A 的附加资源路径数据的源的视频元素。

## {{video-img::A}}

这将被替换为具有当前角色名为 A 的附加资源路径数据的源的视频元素。与 {{video::A}} 不同，该元素将像图像元素一样显示。

## {{raw::A}}

这将被替换为当前角色名为 A 的附加资源路径数据。

## {{image::A}}

这将被替换为具有当前角色名为 A 的附加资源路径数据的源的图像元素。

## {{img::A}}

这将被替换为具有当前角色名为 A 的附加资源路径数据的源的无样式图像元素。

## {{assetlist}}

这将被替换为当前角色附加资源名称的数组。

## {{emotionlist}}

这将被替换为当前角色情感图像名称的数组。

## {{source::A}}

这将被替换为图标的路径。如果 A 是 char，它将被替换为角色图标的路径。如果 A 是 user，它将被替换为用户图标的路径。

# 数学语法

## {{? A}}

别名: {{calc::A}}

这将被替换为提供的表达式 A 的计算结果。例如，{{? 5+3}} 将被替换为 8。您可以在表达式中嵌套其他语法。

支持的运算符和函数如下：

A+B 表示 A 和 B 的加法。

A-B 表示 A 减去 B。

A*B 表示 A 和 B 的乘法。

A/B 表示 A 除以 B。

A%B 表示 A 除以 B 的余数。

A^B 表示 A 的 B 次方。

A||B 表示 A 或 B。

A&&B 表示 A 和 B。

!A 表示非 A。

A==B 表示 A 等于 B。

A!=B 表示 A 不等于 B。

A>B 表示 A 大于 B。

A>=B 表示 A 大于或等于 B。

A<B 表示 A 小于 B。

A<=B 表示 A 小于或等于 B。

$<name> 用于获取名为 <name> 的聊天变量的值。<name> 应仅由字母数字字符和下划线组成。

某些语法有别名：

| 代表 ||

& 代表 &&

= 代表 ==

≤ 代表 <=

≥ 代表 >=

布尔值表示为 1（真）和 0（假）。请注意，{{? A}} 语法仅适用于数字和布尔值。对于字符串值，请使用其他语法，如 {{equal::A::B}}。

## {{equal::A::B}}

如果 A 等于 B，则替换为 1，否则替换为 0。与 {{? A}} 不同，此语法适用于任何类型的值。

## {{not_equal::A::B}}

别名: {{notequal::A::B}}

如果 A 不等于 B，则替换为 1，否则替换为 0。与 {{? A}} 不同，此语法适用于任何类型的值。

## {{remaind::A::B}}

这将被替换为 A 除以 B 的余数。

## {{greater::A::B}}

如果 A 大于 B，则替换为 1，否则替换为 0。

## {{greater_equal::A::B}}

别名: {{greaterequal::A::B}}

如果 A 大于或等于 B，则替换为 1，否则替换为 0。

## {{less::A::B}}

如果 A 小于 B，则替换为 1，否则替换为 0。

## {{less_equal::A::B}}

别名: {{lessequal::A::B}}

如果 A 小于或等于 B，则替换为 1，否则替换为 0。

## {{and::A::B}}

如果 A 和 B 都为 1，则替换为 1，否则替换为 0。

## {{or::A::B}}

如果 A 或 B 为 1，则替换为 1，否则替换为 0。

## {{pow::A::B}}

这将被替换为 A 的 B 次方。

## {{not::A}}

如果 A 为 0，则替换为 1，否则替换为 0。

## {{floor::A}}

这将被替换为小于或等于 A 的最大整数。

## {{ceil::A}}

这将被替换为大于或等于 A 的最小整数。

## {{abs::A}}

这将被替换为 A 的绝对值。

## {{round::A}}

这将被替换为四舍五入到最接近整数的 A。

## {{min::A::B::C...}}

这将被替换为 A, B, C 等中的最小值。如果只提供一个参数，A 将被视为值数组。

## {{max::A::B::C...}}

这将被替换为 A, B, C 等中的最大值。如果只提供一个参数，A 将被视为值数组。

## {{sum::A::B::C...}}

这将被替换为 A, B, C 等的总和。如果只提供一个参数，A 将被视为值数组。

## {{average::A::B::C...}}

这将被替换为 A, B, C 等的平均值。如果只提供一个参数，A 将被视为值数组。

## {{fix_number::A::B}}

这将被替换为 A，小数位数固定为 B。

# 字符串语法
## {{startswith::A::B}}

如果 A 以 B 开头，则替换为 1，否则替换为 0。

## {{endswith::A::B}}

如果 A 以 B 结尾，则替换为 1，否则替换为 0。

## {{contains::A::B}}

如果 A 包含 B，则替换为 1，否则替换为 0。

## {{lower::A}}

这将被替换为转换为小写的 A。

## {{upper::A}}

这将被替换为转换为大写的 A。

## {{capitalize::A}}

这将被替换为首字母大写的 A。

## {{trim::A}}

这将被替换为去除前导和尾随空格的 A。

## {{unicode_encode::A}}

这将被替换为编码为 Unicode 的 A。结果将是数字格式。

## {{unicode_decode::A}}

这将被替换为从 Unicode 解码的 A。输入应为数字格式。

# 条件语法

## {{prefill_supported}}

如果模型支持预填充，则替换为 1，否则替换为 0。

## {{jbtoggled}}

这将被替换为越狱开关的当前状态。如果启用越狱，则替换为 1，否则替换为 0。

## {{isfirstmsg}}

如果消息是聊天中的第一条消息，则替换为 1，否则替换为 0。

## {{all::A::B::C...}}

如果所有参数都为 1，则替换为 1，否则替换为 0。如果只提供一个参数，A 将被视为值数组。

## {{any::A::B::C...}}

如果任何参数为 1，则替换为 1，否则替换为 0。如果只提供一个参数，A 将被视为值数组。

## {{module_enabled::A}}

如果命名空间为 A 的模块已启用，则替换为 1，否则替换为 0。

# 变量语法

## {{getvar::A}}

这将被替换为聊天变量 A 的值。如果未定义聊天变量 A，它将被替换为 null。

## {{setvar::A::B}}

这将把聊天变量 A 设置为 B，并被替换为空字符串。{{setvar::A::B}} 仅在聊天上下文中且不是第一条消息时才有效。

如果可能，建议使用触发器脚本代替此语法。

## {{addvar::A::B}}

这将使聊天变量 A 增加 B，并被替换为空字符串。例如，如果变量 A 是 5，并且使用了 {{addvar::A::3}}，则变量 A 将变为 8。{{addvar::A::B}} 仅在聊天上下文中且不是第一条消息时才有效。

## {{settempvar::A::B}}

这将把临时变量 A 设置为 B，并被替换为空字符串。{{settempvar::A::B}} 仅在聊天上下文中且不是第一条消息时才有效。

临时变量仅在当前上下文中可用，关闭聊天时不会保存，但它经过性能优化。

## {{gettempvar::A}}

这将被替换为临时变量 A 的值。如果未定义临时变量 A，它将被替换为 null。

## {{getglobalvar::A}}

这将被替换为全局变量 A 的值。如果未定义全局变量 A，它将被替换为 null。

# 数组语法

## {{array::A::B::C...}}

这将被替换为由 B, C 等组成的数组。这可用于从多个参数创建数组。

目前数组使用 § 作为分隔符，但这在将来可能会改变。因此，建议使用此语法而不是直接使用 §。

## {{array_length::A}}

别名: {{arraylength::A}}

这将被替换为数组 A 的长度。这不适用于字符串。

## {{array_element::A::B}}

这将被替换为数组 A 中索引为 B 的元素。索引从 0 开始。如果索引超出范围，它将被替换为 null。如果索引是负数，它将从数组的末尾开始计数。

## {{array_push::A::B}}

这将被替换为将元素 B 推到末尾的数组 A。

## {{array_pop::A}}

这将被替换为移除了最后一个元素的数组 A。

## {{array_shift::A}}

这将被替换为移除了第一个元素的数组 A。

## {{array_splice::A::B::C::D...}}

这将被替换为在索引 B 处插入了 C, D 等的数组 A。

## {{array_assert::A::B::C}}

这将被替换为在索引 B 处插入了元素 C 的数组 A。

## {{split::A::B}}

这将被替换为由 B 在 A 中分隔的字符串数组。

## {{join::A::B}}

这将被替换为通过用 B 连接数组 A 的元素而创建的字符串。

## {{filter::A::B}}

这将被替换为经过筛选的数组 A。筛选器 B 是选项。选项有：

nonempty: 移除空字符串。

unique: 移除重复元素。

all: 执行 nonempty 和 unique 两种筛选。

#字典语法

## {{dict::A=B::C=D...}}

别名: {{object::A=B::C=D...}}, {{o::A=B::C=D...}}, {{d::A=B::C=D...}}

这将被替换为键为 A, C 等，值为 B, D 等的字典。

## {{dict_element::A::B}}

别名: {{object_element::A::B}}

这将被替换为字典 A 中键 B 的值。

## {{dict_assert::A::B::C}}

别名: {{object_assert::A::B::C}}

这将被替换为插入了键 B 和值 C 的字典 A。

# 实用工具语法

## {{slot}}

如果在提示模板、管道或翻译器提示中使用，它将被替换为原始插槽内容。否则，它不会被替换。

## {{slot::A}}

如果在 {{#each C D}} 块中使用，并且如果 D 与 A 相同，它将被替换为数组的当前元素。否则，它不会被替换。

## {{position::A}}

如果在提示模板中使用，它将被替换为使用 pt_<A>（如 pt_personality）位置的知识库。如果相应的知识库不存在，它将被替换为空字符串。否则，它不会被替换。

## {{random::A::B...}}

别名: {{random:A,B...}}

这将被替换为从提供的参数中随机选择的值。例如，{{random::A::B::C}} 将被替换为 A, B 或 C。如果没有提供参数，它将被替换为 0 到 1 之间的随机数。

## {{pick::A::B...}}

别名: {{pick:A,B...}}

这与 {{random::A::B...}} 的工作方式相同，只是对于同一条消息，种子将是相同的，这将使结果保持一致。这在没有参数的情况下也不起作用。

## {{roll::A}}

别名: {{roll:A}}

这将被替换为 1 和 A 之间的随机数。如果 A 以 d 开头，它将被替换为 1 和去掉 d 的 A 之间的随机数。

## {{rollp::A}}

别名: {{rollp:A}}

这与 {{roll::A}} 的工作方式相同，只是对于同一条消息，种子将是相同的，这将使结果保持一致。

## {{spread::A}}

这将被替换为通过用 ::（两个冒号）连接数组 A 的元素而创建的字符串。这可用于从数组创建多参数语法。例如，{{random::{{spread::{{array::chicken::pizza::hamburger}}}}}} 的作用与 {{random::chicken::pizza::hamburger}} 相同。

## {{replace::A::B::C}}

这将被替换为 A 中所有出现的 B 都被 C 替换。

## {{range::A}}

这将被替换为从 0 到 A - 1 的数字数组。

## {{length::A}}

这将被替换为 A 的长度。这不适用于数组。

## {{none}}

别名: {{blank}}

这将被替换为空字符串。用于删除默认文本。

如果在第一条消息中使用，则第一条消息将如同不存在一样工作。

## {{br}}

别名: {{newline}}

这将被替换为换行符。

## {{tonumber::A}}

这将修剪除 . 之外的所有非数字字符。这不保证结果是有效的数字。

## {{return::A}}

如果提供了此语法，消息将被替换为 A，并且消息的其余部分将被忽略。

## {{func::A::B::C...}}

这将被替换为带有参数 B, C 等的函数 A 的结果。

## {{arg::A}}

如果使用 {{func::A::B::C...}} 调用，这将被替换为函数参数索引 A。

# 块语法

## {{#if A}} 

如果 A 为 1，则替换为内容，否则替换为空字符串。

示例：

Generated code
{{#if {{equal::1::1}}}}
你好爱丽丝！
{{/if}}```

#### #{{#if-pure A}}
与 `{{#if A}}` 相同，但它会保留内容的缩进和空白。

#### #{{#each A B}}
这将为数组 A 的每个元素替换为内容。数组的当前元素将被替换为 B。

示例：


{{#each {{array::chicken::pizza::hamburger}} item}}
{{slot::item}}
{{/each}}

Generated code
将被替换为：
IGNORE_WHEN_COPYING_START
content_copy
download
Use code with caution.
IGNORE_WHEN_COPYING_END

chickenpizzahamburger

Generated code
#### #{{#func A}}
这将被替换为函数 A 的结果。可以使用 `{{func::A::B::C...}}` 调用该函数。

#### #{{#pure_display}}
这将被替换为没有任何格式的内容。这对于显示原始文本很有用。
IGNORE_WHEN_COPYING_START
content_copy
download
Use code with caution.
IGNORE_WHEN_COPYING_END